name: Deploy to Local Minikube

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
  push:
    branches:
      - main
    paths:
      - "charts/**"
      - "monitoring/**"
      - ".github/workflows/deploy-local-minikube.yaml"
  pull_request:
    branches:
      - main
    paths:
      - "charts/**"
      - "monitoring/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Minikube
        uses: medyagh/setup-minikube@v0.0.14

      - name: Start Minikube
        run: minikube start --driver=docker

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Create kd-cruise namespace
        run: |
          kubectl get ns kd-cruise || kubectl create ns kd-cruise

      - name: Create monitoring namespace
        run: |
          kubectl get ns monitoring || kubectl create ns monitoring

      - name: Add Prometheus and Grafana Helm repos
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Install Prometheus stack
        run: |
          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            -n monitoring \
            -f monitoring/prometheus-values.yaml

      - name: Update Helm dependencies for umbrella chart
        run: |
          helm dependency update charts/kd-cruise

      - name: Install kd-cruise stack
        run: |
          helm upgrade --install kd-cruise charts/kd-cruise -n kd-cruise

      - name: Install Grafana
        run: |
          helm upgrade --install grafana grafana/grafana -n monitoring

      - name: Verify deployments
        run: |
          echo "KD Cruise Deployments:"
          kubectl get pods -n kd-cruise
          echo "Monitoring Deployments:"
          kubectl get pods -n monitoring

      - name: Verify services
        run: |
          echo "KD Cruise Services:"
          kubectl get svc -n kd-cruise
          echo "Monitoring Services:"
          kubectl get svc -n monitoring
